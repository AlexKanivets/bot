# Реализация модуля юридических документов при первом запуске

## Что реализовано

### 1. Новая функциональность в `legal_docs/settings.py`
- `FIRST_LAUNCH_LEGAL_DOCS_ENABLED` - включение/отключение показа документов при первом запуске
- `ACCEPT_BUTTON_TEXT` - текст кнопки "Принять"
- `FIRST_LAUNCH_MESSAGE` - сообщение при первом запуске

### 2. Новые тексты в `legal_docs/texts.py`
- `FIRST_LAUNCH_LEGAL_MESSAGE` - основное сообщение при первом запуске
- `DOCUMENTS_ACCEPTED_MESSAGE` - сообщение после принятия документов
- `ACCEPT_DOCUMENTS_BUTTON` - текст кнопки принятия

### 3. Обновленный роутер в `legal_docs/router.py`
- Новый хук `start_menu_hook` для интеграции с существующим хуком `start_menu`
- Функция `_build_first_launch_buttons()` для создания кнопок первого запуска
- Обработчик `accept_legal_documents` для кнопки "Принять"
- Автоматическая регистрация хука `start_menu`

### 4. Минимальные изменения в `start.py`
- Добавлена логика проверки флага `replace_menu` в существующую функцию `show_start_menu`
- Замена стандартного меню на юридические документы при первом запуске
- Сохранение всей существующей функциональности

## Как это работает

### При первом запуске пользователя:
1. Пользователь отправляет команду `/start`
2. Функция `show_start_menu` вызывается как обычно
3. Внутри функции вызывается хук `start_menu` для получения кнопок модулей
4. Хук `start_menu_hook` проверяет, является ли это первым запуском (нет ключей и не активен пробный период)
5. Если это первый запуск, хук возвращает специальный объект с флагом `replace_menu: True`
6. Функция `show_start_menu` обнаруживает этот флаг и заменяет стандартное меню на юридические документы

### После принятия документов:
1. Пользователь нажимает кнопку "Принять"
2. Обработчик `accept_legal_documents` показывает сообщение об успешном принятии
3. Автоматически перезапускается команда `/start` для показа стандартного меню

## Преимущества использования существующего хука start_menu

1. **Минимальные изменения**: Не требует переписывания основной логики бота
2. **Естественная интеграция**: Использует уже существующий механизм показа меню
3. **Совместимость**: Работает с существующими модулями без конфликтов
4. **Простота**: Логика замены меню добавлена только в одном месте
5. **Надежность**: Использует проверенный механизм хуков бота

## Настройки

### Включение/отключение функциональности:
```python
# В legal_docs/settings.py
FIRST_LAUNCH_LEGAL_DOCS_ENABLED = True  # Включить показ при первом запуске
LEGAL_DOCS_ENABLED = True               # Включить весь модуль
```

### Настройка отображения в разделе "О сервисе":
```python
DISPLAY_MODE = "direct"        # "direct" или "menu"
DIRECT_LAYOUT = "separate_rows"  # "separate_rows" или "same_row"
```

## Технические детали

### Структура хука start_menu:
```python
async def start_menu_hook(**kwargs):
    # Получаем параметры: chat_id, session
    # Проверяем первый запуск
    # Возвращаем {"replace_menu": True, "text": "...", "buttons": [...]} если нужно
```

### Обработка в show_start_menu:
```python
module_buttons = await run_hooks("start_menu", chat_id=message.chat.id, session=session)

# Проверяем замену меню
if module_buttons and isinstance(module_buttons, list):
    for module_data in module_buttons:
        if isinstance(module_data, dict) and module_data.get("replace_menu"):
            # Заменяем меню на юридические документы
            return
```

## Преимущества реализации

1. **Модульность**: Функциональность полностью отделена от основного кода бота
2. **Гибкость**: Можно легко включить/отключить любую часть функциональности
3. **Интеграция**: Использует существующую систему хуков бота без конфликтов
4. **Настраиваемость**: Все тексты и настройки вынесены в отдельные файлы
5. **Безопасность**: Проверка валидности URL документов
6. **UX**: Пользователь не может пропустить принятие документов при первом запуске
7. **Минимальные изменения**: Логика замены меню добавлена только в одном месте
8. **Совместимость**: Работает с существующими модулями и хуками

## Структура файлов

```
legal_docs/
├── __init__.py          # Экспорт модуля
├── settings.py          # Все настройки модуля
├── texts.py             # Тексты и сообщения
├── router.py            # Основная логика и обработчики
└── README.md            # Документация
```

## Интеграция

Модуль автоматически интегрируется при импорте:
```python
from legal_docs import router
dp.include_router(router)
```

Хуки регистрируются автоматически:
- `start_menu` - для показа документов при первом запуске (использует существующий хук бота)
- `about_vpn` - для добавления кнопок в раздел "О сервисе"

## Изменения в start.py

Добавлена только одна логика в функцию `show_start_menu`:
- Проверка флага `replace_menu` в результате хука `start_menu`
- Замена стандартного меню на юридические документы при необходимости
- Сохранение всей существующей функциональности

Это минимальное изменение, которое не затрагивает основную логику бота и работает через существующую систему хуков.