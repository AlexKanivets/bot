# Реализация модуля юридических документов при первом запуске

## Что реализовано

### 1. Новая функциональность в `legal_docs/settings.py`
- `FIRST_LAUNCH_LEGAL_DOCS_ENABLED` - включение/отключение показа документов при первом запуске
- `ACCEPT_BUTTON_TEXT` - текст кнопки "Принять"
- `FIRST_LAUNCH_MESSAGE` - сообщение при первом запуске

### 2. Новые тексты в `legal_docs/texts.py`
- `FIRST_LAUNCH_LEGAL_MESSAGE` - основное сообщение при первом запуске
- `DOCUMENTS_ACCEPTED_MESSAGE` - сообщение после принятия документов
- `ACCEPT_DOCUMENTS_BUTTON` - текст кнопки принятия

### 3. Обновленный роутер в `legal_docs/router.py`
- Новый хук `start_link_hook` для интеграции с существующей логикой команды `/start`
- Функция `show_legal_docs_first_launch()` для показа документов при первом запуске
- Обработчик `accept_legal_documents` для кнопки "Принять"
- Автоматическая регистрация хука `start_link`

### 4. Обновленный `start.py`
- Модифицированная функция `process_start_logic` для обработки результата хука `start_link`
- Логика проверки флага `legal_docs_shown` для прерывания стандартной обработки
- Интеграция с существующей системой хуков без изменения основной логики

## Как это работает

### При первом запуске пользователя:
1. Пользователь отправляет команду `/start`
2. Функция `process_start_logic` разбивает ссылку на части по символу `-`
3. Для каждой части вызывается хук `start_link` с параметрами `message`, `state`, `session`, `user_data`, `part`
4. Хук `start_link_hook` проверяет, является ли это первым запуском (нет ключей и не активен пробный период)
5. Если это первый запуск, хук показывает юридические документы и возвращает `{"handled": True}`
6. Основная логика бота прерывается, если документы уже показаны

### После принятия документов:
1. Пользователь нажимает кнопку "Принять"
2. Обработчик `accept_legal_documents` показывает сообщение об успешном принятии
3. Автоматически перезапускается команда `/start` для показа стандартного меню

## Преимущества использования хука start_link

1. **Естественная интеграция**: Использует существующую логику обработки команды `/start`
2. **Минимальные изменения**: Не требует переписывания основной логики бота
3. **Гибкость**: Хук может обрабатывать любую часть ссылки, включая пустую
4. **Совместимость**: Работает с существующими модулями и хуками
5. **Производительность**: Проверка первого запуска происходит только при необходимости

## Настройки

### Включение/отключение функциональности:
```python
# В legal_docs/settings.py
FIRST_LAUNCH_LEGAL_DOCS_ENABLED = True  # Включить показ при первом запуске
LEGAL_DOCS_ENABLED = True               # Включить весь модуль
```

### Настройка отображения в разделе "О сервисе":
```python
DISPLAY_MODE = "direct"        # "direct" или "menu"
DIRECT_LAYOUT = "separate_rows"  # "separate_rows" или "same_row"
```

## Технические детали

### Структура хука start_link:
```python
async def start_link_hook(**kwargs):
    # Получаем параметры: message, state, session, user_data, part
    # Проверяем первый запуск
    # Показываем документы если нужно
    # Возвращаем {"handled": True} если документы показаны
```

### Обработка результата в start.py:
```python
hook_result = await run_hooks("start_link", ...)
if hook_result and isinstance(hook_result, list):
    for result in hook_result:
        if isinstance(result, dict) and result.get("handled"):
            legal_docs_shown = True
            break

if legal_docs_shown:
    break  # Прерываем обработку
```

## Преимущества реализации

1. **Модульность**: Функциональность полностью отделена от основного кода бота
2. **Гибкость**: Можно легко включить/отключить любую часть функциональности
3. **Интеграция**: Использует существующую систему хуков бота без конфликтов
4. **Настраиваемость**: Все тексты и настройки вынесены в отдельные файлы
5. **Безопасность**: Проверка валидности URL документов
6. **UX**: Пользователь не может пропустить принятие документов при первом запуске
7. **Производительность**: Минимальные изменения в основном коде

## Структура файлов

```
legal_docs/
├── __init__.py          # Экспорт модуля
├── settings.py          # Все настройки модуля
├── texts.py             # Тексты и сообщения
├── router.py            # Основная логика и обработчики
└── README.md            # Документация
```

## Интеграция

Модуль автоматически интегрируется при импорте:
```python
from legal_docs import router
dp.include_router(router)
```

Хуки регистрируются автоматически:
- `start_link` - для показа документов при первом запуске (интегрируется в существующую логику)
- `about_vpn` - для добавления кнопок в раздел "О сервисе"